//+------------------------------------------------------------------+
//|                                            LiveDataTransmitEA.mq4|
//|                        Your Name/Your Company                    |
//+------------------------------------------------------------------+
#property strict

// Input parameters
input string DataEndpoint = "http://your.api.endpoint/receive_data"; // Replace with your actual API endpoint
input int TransmissionInterval = 10; // Interval in seconds to transmit data

// Variables
datetime lastTransmissionTime;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
   lastTransmissionTime = TimeCurrent(); // Initialize the last transmission time
   // Clear any existing objects on the chart
   ObjectsDeleteAll();
   return(INIT_SUCCEEDED);
  }
//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
  {
   // Clean up chart objects on deinitialization
   ObjectsDeleteAll();
  }
//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
  {
   // Collect market data
   double bid = MarketInfo(Symbol(), MODE_BID);
   double ask = MarketInfo(Symbol(), MODE_ASK);
   datetime currentTime = TimeCurrent();

   // Format the data as a JSON string
   string jsonData = StringFormat("{\"symbol\":\"%s\",\"bid\":%f,\"ask\":%f,\"time\":%d}",
                                  Symbol(), bid, ask, currentTime);

   // Display the data on the chart
   DrawTextOnChart("BidPrice", "Bid: " + DoubleToString(bid, Digits), 10, 20);
   DrawTextOnChart("AskPrice", "Ask: " + DoubleToString(ask, Digits), 10, 40);
   DrawTextOnChart("SendStatus", "Sending Data...", 10, 60);

   // Check if the transmission interval has passed
   if (currentTime >= lastTransmissionTime + TransmissionInterval)
     {
      // Send the data to the API endpoint
      int responseCode = sendDataToAPI(DataEndpoint, jsonData);
      
      if(responseCode == 200)
         DrawTextOnChart("SendStatus", "Data transmitted successfully!", 10, 60);
      else
         DrawTextOnChart("SendStatus", "Error transmitting data, response code: " + IntegerToString(responseCode), 10, 60);

      // Update the last transmission time
      lastTransmissionTime = currentTime;
     }
  }
//+------------------------------------------------------------------+
//| Function to send data to the API                                  |
//+------------------------------------------------------------------+
int sendDataToAPI(string url, string jsonData)
  {
   int timeout = 5000; // Timeout for the HTTP request in milliseconds
   char post[];
   StringToCharArray(jsonData, post); // Convert the JSON string to a character array
   string headers = "Content-Type: application/json\r\n"; // Set the content type to JSON

   // Send the HTTP POST request
   int responseCode = WebRequest("POST", url, headers, timeout, post, 0, NULL, NULL);
   
   if(responseCode == -1)
   {
      Print("Error in WebRequest: ", GetLastError());
   }

   return responseCode; // Return the HTTP response code
  }
//+------------------------------------------------------------------+
//| Function to draw text on the chart                                |
//+------------------------------------------------------------------+
void DrawTextOnChart(string name, string text, int x, int y)
  {
   // Create or update a text object on the chart
   if(ObjectFind(0, name) != 0)
   {
      ObjectCreate(0, name, OBJ_LABEL, 0, 0, 0);
      ObjectSetInteger(0, name, OBJPROP_CORNER, CORNER_LEFT_UPPER);
      ObjectSetInteger(0, name, OBJPROP_XDISTANCE, x);
      ObjectSetInteger(0, name, OBJPROP_YDISTANCE, y);
      ObjectSetInteger(0, name, OBJPROP_COLOR, clrWhite);
      ObjectSetInteger(0, name, OBJPROP_FONTSIZE, 12);
      ObjectSetInteger(0, name, OBJPROP_HIDDEN, true);
   }
   ObjectSetString(0, name, OBJPROP_TEXT, text);
  }
